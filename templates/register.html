{% extends "base.html" %}

{% block title %}Registro - Sistema de Autenticación{% endblock %}

{% block content %}
<h2>Crear Cuenta</h2>

<form method="POST" action="{{ url_for('auth.register') }}">
    {{ csrf_token() if csrf_token }}
    
    <div class="form-group">
        <label for="username">Usuario</label>
        <input type="text" 
               id="username" 
               name="username" 
               value="{{ request.form.username if request.form.username }}"
               required
               minlength="3"
               maxlength="20">
        <small style="color: #666; font-size: 0.8rem;">Mínimo 3 caracteres, máximo 20</small>
    </div>
    
    <div class="form-group">
        <label for="password">Contraseña</label>
        <div class="input-container">
            <input type="password" 
                   id="password" 
                   name="password" 
                   required
                   minlength="4">
            <button type="button" 
                    class="toggle-password" 
                    onclick="togglePassword('password')"
                    title="Mostrar/ocultar contraseña">
                    <i class="fa-solid fa-eye"></i>
            </button>
        </div>
        <small style="color: #666; font-size: 0.8rem;">Mínimo 4 caracteres</small>
    </div>
    
    <div class="form-group">
        <label for="confirm_password">Confirmar Contraseña</label>
        <div class="input-container">
            <input type="password" 
                   id="confirm_password" 
                   name="confirm_password" 
                   required>
            <button type="button" 
                    class="toggle-password" 
                    onclick="togglePassword('confirm_password')"
                    title="Mostrar/ocultar contraseña">
            </button>
        </div>
    </div>
    
    <button type="submit" class="btn btn-primary">
        Crear Cuenta
    </button>
</form>

<div class="link">
    <a href="{{ url_for('auth.login') }}" class="link">
        ¿Ya tienes cuenta? Inicia sesión aquí
    </a>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .form-group small {
        display: block;
        margin-top: 0.25rem;
        font-style: italic;
    }

    .password-strength {
        height: 4px;
        background: #ddd;
        border-radius: 2px;
        margin-top: 0.5rem;
        overflow: hidden;
    }

    .password-strength-bar {
        height: 100%;
        width: 0%;
        transition: all 0.3s;
        border-radius: 2px;
    }

    .strength-weak { background: #dc3545; }
    .strength-medium { background: #ffc107; }
    .strength-strong { background: #28a745; }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Enfocar automáticamente el campo de usuario
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('username').focus();
        
        // Agregar indicador de fortaleza de contraseña
        const passwordInput = document.getElementById('password');
        const passwordGroup = passwordInput.closest('.form-group');
        
        // Crear indicador de fortaleza
        const strengthIndicator = document.createElement('div');
        strengthIndicator.className = 'password-strength';
        strengthIndicator.innerHTML = '<div class="password-strength-bar"></div>';
        passwordGroup.appendChild(strengthIndicator);
        
        const strengthBar = strengthIndicator.querySelector('.password-strength-bar');
        const strengthText = document.createElement('small');
        strengthText.style.color = '#666';
        strengthText.style.fontSize = '0.8rem';
        passwordGroup.appendChild(strengthText);
        
        passwordInput.addEventListener('input', function() {
            const password = this.value;
            let strength = 0;
            let strengthLabel = '';
            
            if (password.length >= 4) strength += 1;
            if (password.length >= 8) strength += 1;
            if (/[A-Z]/.test(password)) strength += 1;
            if (/[0-9]/.test(password)) strength += 1;
            if (/[^A-Za-z0-9]/.test(password)) strength += 1;
            
            const width = (strength / 5) * 100;
            strengthBar.style.width = width + '%';
            
            if (strength <= 2) {
                strengthBar.className = 'password-strength-bar strength-weak';
                strengthLabel = 'Débil';
            } else if (strength <= 3) {
                strengthBar.className = 'password-strength-bar strength-medium';
                strengthLabel = 'Media';
            } else {
                strengthBar.className = 'password-strength-bar strength-strong';
                strengthLabel = 'Fuerte';
            }
            
            strengthText.textContent = password.length > 0 ? `Fortaleza: ${strengthLabel}` : '';
        });
    });

    // Validación del formulario
    document.querySelector('form').addEventListener('submit', function(e) {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        
        // Validar campos vacíos
        if (!username) {
            alert('El campo usuario es obligatorio');
            e.preventDefault();
            document.getElementById('username').focus();
            return;
        }
        
        if (!password) {
            alert('El campo contraseña es obligatorio');
            e.preventDefault();
            document.getElementById('password').focus();
            return;
        }
        
        if (!confirmPassword) {
            alert('Debe confirmar la contraseña');
            e.preventDefault();
            document.getElementById('confirm_password').focus();
            return;
        }
        
        // Validar longitud de usuario
        if (username.length < 3) {
            alert('El usuario debe tener al menos 3 caracteres');
            e.preventDefault();
            document.getElementById('username').focus();
            return;
        }
        
        // Validar longitud de contraseña
        if (password.length < 4) {
            alert('La contraseña debe tener al menos 4 caracteres');
            e.preventDefault();
            document.getElementById('password').focus();
            return;
        }
        
        // Validar que las contraseñas coincidan
        if (password !== confirmPassword) {
            alert('Las contraseñas no coinciden');
            e.preventDefault();
            document.getElementById('confirm_password').focus();
            return;
        }
        
        // Mostrar indicador de carga
        const submitBtn = document.querySelector('.btn-primary');
        submitBtn.textContent = 'Creando cuenta...';
        submitBtn.disabled = true;
    });

    // Validación en tiempo real de confirmación de contraseña
    document.getElementById('confirm_password').addEventListener('input', function() {
        const password = document.getElementById('password').value;
        const confirmPassword = this.value;
        
        if (confirmPassword && password !== confirmPassword) {
            this.style.borderColor = '#dc3545';
            this.style.background = '#fff5f5';
        } else {
            this.style.borderColor = '#ddd';
            this.style.background = '#f8f9fa';
        }
    });
</script>
{% endblock %}